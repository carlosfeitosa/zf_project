<?php
require_once 'Zend/Json.php';


//-----------------------------------------------
function retornaZendFormMessages(Zend_Form $form = null){
	
	$messages = array();
	
	if ($form and $form->isErrors()) {
		if ($form->getSubForms())
			$messages = $form->getMessages();
		else
			$messages[$form->getName()] = $form->getMessages();
			 
	}	
	return $messages;
}

$scripts           = null;
$modules 		   = null;
$dijits 		   = null;
$zendFormsMessages = array();
$viewHeaderHtml    = null;
$viewContentHtml   = null;
$viewFooterHtml    = null;
$formularios       = array();

$formsRenders = array();

// recupera as variáveis e objetos da view
foreach ($this->getVars() as $key => $value){
	
	// verifica se existe objetos do tipo formulário na view
	if (is_subclass_of($value, 'Zend_Form')) {
		Basico_OPController_UtilOPController::print_debug($key);
		
		$formularios[] = $key;		
		$zendFormsMessages += retornaZendFormMessages($this->$key);
			
	}else {
		
	}
}

Basico_OPController_UtilOPController::print_debug($formularios);
//exit;

if (!$zendFormsMessages) {
	echo "não existe mensagens de form";
	
	// seta o form para Programmatic
	Zend_Dojo_View_Helper_Dojo::setUseProgrammatic();
	
	/*
	 * monta dijits a partir do dojo view helper
	 * apos o $this->form->render();
	 */
	
	foreach ($formularios as $key => $value){
		$formsRenders[$value] = $this->$value->render();
	}
	
	$scripts          = $this->dojo()->getJavascript();
	$modules          = $this->dojo()->getModules();
	$dijits           = $this->dojo()->getDijits();
	
}else{
	echo "existe mensagens de form";

}

Basico_OPController_UtilOPController::print_debug($formsRenders);
exit;

$js = <<<JS
alert('ok');
JS;

$this->dojo()->addJavascript($js);


$response = array('view' => array('scripts'           => $scripts,
								  //'modules'           => $modules,
								  //'dijits'            => $dijits,
								  'html'              => array(//'header' => $viewHeaderHtml,
															   //'content' => $viewContentHtml,
															   'footer' => $viewFooterHtml),
								  'zendFormsMessages' => $zendFormsMessages,
								  
								 ),
				 );

//Basico_OPController_UtilOPController::print_debug($response);
echo Zend_Json::encode($response);
exit;
//-----------------------------------------------





$zendFormsMessages = $this->form->getMessages();
$zendDijits = array();

foreach ($zendFormsMessages as $nomeFormulario => $elementos){

	$sub_form = $this->form->getSubForm($nomeFormulario);
	$i = 0;	
	foreach ($elementos as $nomeElemento => $parametros){
		
		/*
		 * monta dijits a partir do zend_form
		 */
		$elemento = $sub_form->getElement($nomeElemento);
		//Basico_OPController_UtilOPController::print_debug($elemento);
		
		$nomeDijit = $elemento->getBelongsTo().'-'.$elemento->getName(); // ou  $nomeDijit = $nomeFormulario.'-'.$nomeElemento;
		//Basico_OPController_UtilOPController::print_debug($nomeDijit);
		
		if ($elemento->dijitParams){
			$dijitParams = $elemento->getDijitParams();
			//Basico_OPController_UtilOPController::print_debug($elemento->getValue());
			//Basico_OPController_UtilOPController::print_debug($dijitParams);			
		}else{
			continue;
		}

		$zendDijits[$i]['id'] = $nomeDijit;
		$zendDijits[$i]['params'] = $dijitParams;

		//$zendDijits[$i]['params']['value'] = 'view value...';

		
														/*
														 * monta dijits a partir do dojo view helper
														 * apos o $this->form->render();
														 */
																//cria os elementos dijits.
																//$this->form->render();
		
														$nomeDijit = $nomeFormulario.'-'.$nomeElemento;
														$dijitParametros = $this->dojo()->getDijit($nomeDijit);
														$dijitParametros['value'] = 'view value...';
																	//array_walk_recursive($params, array($this, '_castBoolToString'));
																		
														$dijits[$i]['id'] = $nomeDijit;
														$dijits[$i]['params'] = $dijitParametros;
														//$dijits = $this->dojo()->getDijits();
														
														
												
														if ($dijitParametros){
															//$this->dojo()->setDijit($nomeDijit, $dijitParametros);
														}
		
		$i++;
		
		//array_walk_recursive($params, array($this, '_castBoolToString'));
	}

}

sleep(2);



if ($zendFormsMessages){
	echo Zend_Json::encode(array('view'=> array(
		//'content' => $this->layout()->content,
		//'content' => $content,
		//dojo require information
		//'modules' => $this->dojo()->getModules(),
		'dijits' => $this->dojo()->getDijits(),
		'zendFormDijits' => $zendDijits,
		'zendFormsMessages' => $zendFormsMessages,
	)));
}else {
	echo Zend_Json::encode(true);	
}